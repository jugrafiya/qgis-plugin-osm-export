# -*- coding: utf-8 -*-
"""
/***************************************************************************
 OSMExportDialog
                                 A QGIS plugin
 A plugin to download OSM data for the current map extent and export it to a file.
 Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
                             -------------------
        begin                : 2024-01-31
        git sha              : $Format:%H$
        copyright            : (C) 2024 by Jugrafiya
        email                : muhammad.tayyab@jugrafiya.com
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
"""

import os

from qgis.PyQt import uic
from qgis.PyQt import QtWidgets
from qgis.PyQt.QtWidgets import QDialog, QMessageBox, QPushButton
from qgis.core import QgsCoordinateTransform, QgsCoordinateReferenceSystem, QgsProject, QgsPointXY, QgsGeometry, QgsFeature, QgsVectorLayer, QgsField, QgsWkbTypes, QgsProcessingFeedback, QgsVectorFileWriter
from PyQt5.QtCore import QVariant
import requests
import overpy
import processing

# This loads your .ui file so that PyQt can populate your plugin with the elements from Qt Designer
FORM_CLASS, _ = uic.loadUiType(os.path.join(
    os.path.dirname(__file__), 'osm_export_dialog_base.ui'))


class OSMExportDialog(QtWidgets.QDialog, FORM_CLASS):
    def __init__(self, iface, parent=None):
        """Constructor."""
        super(OSMExportDialog, self).__init__(parent)

        self.setupUi(self)
        self.iface = iface

        # Connect the button click event to the method
        self.btnShowExtent.clicked.connect(self.show_current_extent)

    def download_osm_data(self, in_extent):
        params = {
            'EXTENT': in_extent,  # [minx, miny, maxx, maxy]
            'OUTPUT_POINTS': 'OUTPUT_POINTS',
            'OUTPUT_LINES': 'OUTPUT_LINES',
            'OUTPUT_MULTIPOLYGONS': 'OUTPUT_MULTIPOLYGONS'
        }
        feedback = QgsProcessingFeedback()
        
        result = processing.run('quickosm:downloadosmdataextentquery', params, feedback=feedback)

        return result

    def show_current_extent(self):
        # Get the current map extent
        extent = self.iface.mapCanvas().extent()

        # Calculate the center of the extent
        center_x = (extent.xMinimum() + extent.xMaximum()) / 2
        center_y = (extent.yMinimum() + extent.yMaximum()) / 2

        # Create a point at the center
        center_point = QgsPointXY(center_x, center_y)

        # Check if the map is already in a geographic coordinate system
        map_crs = self.iface.mapCanvas().mapSettings().destinationCrs()
        geo_crs = QgsCoordinateReferenceSystem('EPSG:4326')  # WGS 84

        # Transform the center point to geographic coordinates if necessary
        if map_crs != geo_crs:
            transform = QgsCoordinateTransform(map_crs, geo_crs, QgsProject.instance())
            center_point = transform.transform(center_point)

        # Calculate the UTM zone from the longitude
        utm_zone = int((center_point.x() + 180) / 6) + 1

        try:
            # Use the above funtion to download and display OSM data
            osmdata = self.download_osm_data(extent)

            for output in ['OUTPUT_LINES', 'OUTPUT_MULTIPOLYGONS']:
                layer = osmdata[output]
                if layer is not None:
                    # Transform the layer to the UTM zone
                    # transform = QgsCoordinateTransform(geo_crs, QgsCoordinateReferenceSystem(f'EPSG:326{utm_zone}'), QgsProject.instance())
                    # layer.setCrs(QgsCoordinateReferenceSystem(f'EPSG:326{utm_zone}'))  # Set the CRS for the layer

                    # Add the transformed layer to the map
                    QgsProject.instance().addMapLayer(layer)

                    # Export the transformed layers to .dxf files to D: drive
                    path = f'D:/osm_{output}.dxf'
                    QgsVectorFileWriter.writeAsVectorFormat(layer, path, 'UTF-8', layer.crs(), 'DXF', layerOptions=['ENCODING=UTF-8'])
            
            QMessageBox.information(
                None, "OSM Data Download", f"Successfully downloaded OSM data for the current extent.", QMessageBox.Ok)
            # Here you could process the result or save it to a file, etc.

        except overpy.exception.OverpassTooManyRequests:
            QMessageBox.warning(
                None, "OSM Data Download", "Too many requests to Overpass API. Please try again later.", QMessageBox.Ok)
        except Exception as e:
            QMessageBox.warning(
                None, "OSM Data Download", f"An error occurred: {str(e)}", QMessageBox.Ok)

    